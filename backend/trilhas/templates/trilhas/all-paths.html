<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minhas Trilhas - EstudaAI</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/global.css' %}">
  <link rel="stylesheet" href="{% static 'css/minhasTrilhas.css' %}">
  <style></style>
</head>
<body>
  <nav class="navbar">
    <div class="container navbar-content">
      <a href="{% url 'trilhas:dashboard' %}" class="navbar-brand">
        <div class="logo">ğŸ“</div>
        <span>EstudaAI</span>
      </a>
      <ul class="navbar-menu">
        <li><a href="{% url 'trilhas:dashboard' %}">Dashboard</a></li>
        <li><a href="{% url 'trilhas:minhas_trilhas' %}" class="active">Minhas Trilhas</a></li>
        <li><a href="{% url 'trilhas:todas_trilhas' %}">Explorar</a></li>
        <li><a href="{% url 'trilha_personalizada' %}">Criar Trilha</a></li>
      </ul>
      <div class="navbar-actions">
        <div class="user-profile" onclick="toggleUserMenu()">
          <div class="user-avatar">{{ request.user.nickname|first|upper }}</div>
          <span id="userName">{{ request.user.nickname }}</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="container-wide">
      <div class="page-header">
        <h1 class="page-title">Minhas Trilhas</h1>
        <p class="page-subtitle">Gerencie todas as suas trilhas de aprendizagem</p>
      </div>

      <!-- Grids -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Em Progresso</h2>
          <span class="section-badge" id="inProgressCount">0</span>
        </div>
        <div class="paths-grid" id="inProgressGrid"></div>
      </div>
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Pausadas</h2>
          <span class="section-badge" id="pausedCount">0</span>
        </div>
        <div class="paths-grid" id="pausedGrid"></div>
      </div>
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">ConcluÃ­das</h2>
          <span class="section-badge" id="completedCount">0</span>
        </div>
        <div class="paths-grid" id="completedGrid"></div>
      </div>
    </div>
  </main>

  <script>
    // Helpers
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }

    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function createPathCard(path, status) {
      const div = document.createElement('div');
      div.className = `path-card ${status}`;
      div.innerHTML = `
        <div class="path-card-header">
          <span class="path-status-badge ${status}">
            ${status==='in-progress'?'ğŸ”„ Em Progresso':status==='paused'?'â¸ï¸ Pausada':'âœ… ConcluÃ­da'}
          </span>
          <div style="position:relative;">
            <button class="path-menu-btn" onclick="toggleMenu(event, ${path.id})">â‹®</button>
            <div class="path-menu" id="menu-${path.id}"></div>
          </div>
        </div>
        <div onclick="verDetalhes(${path.id})" style="cursor:pointer">
          <div class="card-title" style="font-weight:600; margin-bottom:6px;">${escapeHtml(path.title)}</div>
          <div class="card-description" style="color:var(--text-secondary);">${escapeHtml(path.description)}</div>
          <div class="path-meta">
            <span>ğŸ“Š ${escapeHtml(path.level)}</span>
          </div>
          ${status!=='completed'?`<div class="path-progress">
            <div class="progress-label">
              <span>Progresso</span><span>${path.progress}%</span>
            </div>
            <div class="progress-bar" style="background:var(--bg-tertiary); height:8px; border-radius:6px;">
              <div style="width:${path.progress}%; background:var(--accent-primary); height:8px; border-radius:6px;"></div>
            </div>
          </div>`:''}
        </div>
      `;
      const menu = div.querySelector('.path-menu');
      // Menu items por status
      if (status==='in-progress') {
        menu.innerHTML = `
          <div class="path-menu-item" onclick="pauseTrilha(${path.id})">â¸ï¸ Pausar trilha</div>
          <div class="path-menu-item" onclick="verDetalhes(${path.id})">ğŸ‘ï¸ Ver detalhes</div>
          <div class="path-menu-item danger" onclick="deleteTrilha(${path.id})">ğŸ—‘ï¸ Excluir trilha</div>
        `;
      } else if (status==='paused') {
        menu.innerHTML = `
          <div class="path-menu-item" onclick="resumeTrilha(${path.id})">â–¶ï¸ Retomar trilha</div>
          <div class="path-menu-item" onclick="verDetalhes(${path.id})">ğŸ‘ï¸ Ver detalhes</div>
          <div class="path-menu-item danger" onclick="deleteTrilha(${path.id})">ğŸ—‘ï¸ Excluir trilha</div>
        `;
      } else {
        menu.innerHTML = `
          <div class="path-menu-item" onclick="verDetalhes(${path.id})">ğŸ‘ï¸ Ver detalhes</div>
          <div class="path-menu-item" onclick="restartTrilha(${path.id})">ğŸ”„ Refazer trilha</div>
          <div class="path-menu-item danger" onclick="deleteTrilha(${path.id})">ğŸ—‘ï¸ Remover da lista</div>
        `;
      }
      return div;
    }

    // Toggle menu
    function toggleMenu(event, id) {
      event.stopPropagation();
      document.querySelectorAll('.path-menu').forEach(m=>m.id!==`menu-${id}`?m.classList.remove('show'):null);
      document.getElementById(`menu-${id}`)?.classList.toggle('show');
    }
    document.addEventListener('click', ()=>document.querySelectorAll('.path-menu').forEach(m=>m.classList.remove('show')));

    // Carrega e renderiza
    document.addEventListener('DOMContentLoaded', async ()=>await carregarEExibir());

    async function carregarEExibir() {
      try {
        const url = "{% url 'trilhas:minhas_trilhas' %}?format=json";
        const res = await fetch(url,{credentials:'same-origin'});
        if(!res.ok)throw new Error('Falha ao buscar trilhas');
        const data = await res.json();
        populateGrid('inProgressGrid', data.inProgress, 'in-progress');
        populateGrid('pausedGrid', data.paused, 'paused');
        populateGrid('completedGrid', data.completed, 'completed');
      } catch(err){
        console.error(err);
        document.getElementById('inProgressGrid').innerHTML='<div class="empty-state"><div class="empty-state-title">Erro ao carregar trilhas</div></div>';
        document.getElementById('pausedGrid').innerHTML='';
        document.getElementById('completedGrid').innerHTML='';
      }
    }

    function populateGrid(gridId, items, status){
      const grid = document.getElementById(gridId);
      const countEl = document.getElementById(gridId.replace('Grid','Count'));
      grid.innerHTML='';
      countEl.textContent=items.length||0;
      if(!items||items.length===0){
        grid.innerHTML=`<div class="empty-state">
          <div class="empty-state-icon">ğŸ“š</div>
          <div class="empty-state-title">Nenhuma trilha ${status==='in-progress'?'em progresso':status==='paused'?'pausada':'concluÃ­da'}</div>
          <div class="empty-state-description">${status==='in-progress'?'Comece':status==='paused'?'Pause':'Conclua'} uma trilha para aparecer aqui </div>
        </div>`;
        return;
      }
      items.forEach(p=>{
        const path={
          id:p.id,
          title:p.title||p.titulo||'Sem tÃ­tulo',
          description:p.description||p.descricao||'',
          duration:p.duration||'â€”',
          level:p.level||'â€”',
          progress:typeof p.progress==='number'?p.progress:(p.progress||0)
        };
        grid.appendChild(createPathCard(path,status));
      });
    }

    // FunÃ§Ãµes de aÃ§Ã£o
    async function sendAction(action,trilhaId){
      const url="{% url 'trilhas:minhas_trilhas' %}";
      const body=`action=${encodeURIComponent(action)}&trilha_id=${encodeURIComponent(trilhaId)}`;
      const res = await fetch(url,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body});
      if(res.ok){try{const json=await res.json();}catch(e){}await carregarEExibir();}
      else {const text=await res.text();console.error('Erro aÃ§Ã£o:',res.status,text);alert('Erro ao executar aÃ§Ã£o');}
    }

    function pauseTrilha(id){sendAction('pause',id);}
    function resumeTrilha(id){sendAction('resume',id);}
    function restartTrilha(id){sendAction('restart',id);}
    function deleteTrilha(id){
      if(confirm('Tem certeza que deseja excluir esta trilha?')) sendAction('delete',id);
    }
    function verDetalhes(id){window.location.href='{% url "trilhas:ver_etapas" %}?id='+encodeURIComponent(id);}
  </script>
</body>
</html>