<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minhas Trilhas - EstudaAI</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/global.css' %}">
  <style>
    /* === estilo original mantido === */
    .main-content { padding: 48px 0; }
    .page-header {margin-bottom: 48px;text-align: center; display: flex; flex-direction: column; align-items: center; }

    .page-title { font-size: 36px; font-weight: 700; margin-bottom: 8px; }
    .page-subtitle { font-size: 16px; color: var(--text-secondary); }
    .section { margin-bottom: 64px; }
    .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .section-title { font-size: 24px; font-weight: 600; }
    .section-badge { padding: 4px 12px; background-color: var(--accent-light); color: var(--accent-primary); border-radius: 999px; font-size: 13px; font-weight: 600; }
    .paths-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px; }
    .path-card { cursor: pointer; position: relative; overflow: hidden; background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); }
    .path-card.in-progress::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--accent-primary), #8b5cf6); }
    .path-card.paused::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #f59e0b, #f97316); }
    .path-card.completed::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #10b981, #059669); }
    .path-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
    .path-status-badge { padding:4px 12px; border-radius:999px; font-size:12px; font-weight:600; }
    .path-status-badge.in-progress { background-color: var(--accent-light); color: var(--accent-primary); }
    .path-status-badge.paused { background-color: rgba(245,158,11,0.1); color:#f59e0b; }
    .path-status-badge.completed { background-color: rgba(16,185,129,0.1); color:#10b981; }
    .path-menu-btn { background:transparent; border:none; color:var(--text-secondary); font-size:20px; cursor:pointer; padding:4px 8px; border-radius:4px; position:relative; }
    .path-menu { display:none; position:absolute; top:100%; right:0; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow-lg); min-width:160px; z-index:100; margin-top:6px; }
    .path-menu.show { display:block; }
    .path-menu-item { padding:12px 16px; cursor:pointer; font-size:14px; color:var(--text-primary); display:flex; gap:8px; align-items:center; }
    .path-menu-item.danger { color:#ef4444; }
    .path-meta { display:flex; gap:16px; margin-top:16px; font-size:13px; color:var(--text-muted); }
    .path-progress { margin-top:16px; }
    .progress-label { display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px; }
    .empty-state { text-align:center; padding:64px 24px; color:var(--text-secondary); }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container navbar-content">
      <a href="{% url 'trilhas:dashboard' %}" class="navbar-brand">
        <div class="logo">üéì</div>
        <span>EstudaAI</span>
      </a>
      <ul class="navbar-menu">
        <li><a href="{% url 'trilhas:dashboard' %}">Dashboard</a></li>
        <li><a href="{% url 'trilhas:minhas_trilhas' %}" class="active">Minhas Trilhas</a></li>
        <li><a href="{% url 'trilhas:todas_trilhas' %}">Explorar</a></li>
        <li><a href="{% url 'trilha_personalizada' %}">Criar Trilha</a></li>
      </ul>
      <div class="navbar-actions">
        <div class="user-profile" onclick="toggleUserMenu()">
          <div class="user-avatar">{{ request.user.username|first|upper }}</div>
          <span id="userName">{{ request.user.username }}</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="container-wide">
      <div class="page-header">
        <h1 class="page-title">Minhas Trilhas</h1>
        <p class="page-subtitle">Gerencie todas as suas trilhas de aprendizagem</p>
      </div>

      <!-- Grids -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Em Progresso</h2>
          <span class="section-badge" id="inProgressCount">0</span>
        </div>
        <div class="paths-grid" id="inProgressGrid"></div>
      </div>
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Pausadas</h2>
          <span class="section-badge" id="pausedCount">0</span>
        </div>
        <div class="paths-grid" id="pausedGrid"></div>
      </div>
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">Conclu√≠das</h2>
          <span class="section-badge" id="completedCount">0</span>
        </div>
        <div class="paths-grid" id="completedGrid"></div>
      </div>
    </div>
  </main>

  <script>
    // Helpers
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }

    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function createPathCard(path, status) {
      const div = document.createElement('div');
      div.className = `path-card ${status}`;
      div.innerHTML = `
        <div class="path-card-header">
          <span class="path-status-badge ${status}">
            ${status==='in-progress'?'üîÑ Em Progresso':status==='paused'?'‚è∏Ô∏è Pausada':'‚úÖ Conclu√≠da'}
          </span>
          <div style="position:relative;">
            <button class="path-menu-btn" onclick="toggleMenu(event, ${path.id})">‚ãÆ</button>
            <div class="path-menu" id="menu-${path.id}"></div>
          </div>
        </div>
        <div onclick="verDetalhes(${path.id})" style="cursor:pointer">
          <div class="card-title" style="font-weight:600; margin-bottom:6px;">${escapeHtml(path.title)}</div>
          <div class="card-description" style="color:var(--text-secondary);">${escapeHtml(path.description)}</div>
          <div class="path-meta">
            <span>‚è±Ô∏è ${escapeHtml(path.duration)}</span>
            <span>üìä ${escapeHtml(path.level)}</span>
          </div>
          ${status!=='completed'?`<div class="path-progress">
            <div class="progress-label">
              <span>Progresso</span><span>${path.progress}%</span>
            </div>
            <div class="progress-bar" style="background:var(--bg-tertiary); height:8px; border-radius:6px;">
              <div style="width:${path.progress}%; background:var(--accent-primary); height:8px; border-radius:6px;"></div>
            </div>
          </div>`:''}
        </div>
      `;
      const menu = div.querySelector('.path-menu');
      // Menu items por status
      if (status==='in-progress') {
        menu.innerHTML = `
          <div class="path-menu-item" onclick="pauseTrilha(${path.id})">‚è∏Ô∏è Pausar trilha</div>
          <div class="path-menu-item" onclick="verDetalhes(${path.id})">üëÅÔ∏è Ver detalhes</div>
          <div class="path-menu-item danger" onclick="deleteTrilha(${path.id})">üóëÔ∏è Excluir trilha</div>
        `;
      } else if (status==='paused') {
        menu.innerHTML = `
          <div class="path-menu-item" onclick="resumeTrilha(${path.id})">‚ñ∂Ô∏è Retomar trilha</div>
          <div class="path-menu-item" onclick="verDetalhes(${path.id})">üëÅÔ∏è Ver detalhes</div>
          <div class="path-menu-item danger" onclick="deleteTrilha(${path.id})">üóëÔ∏è Excluir trilha</div>
        `;
      } else {
        menu.innerHTML = `
          <div class="path-menu-item" onclick="verDetalhes(${path.id})">üëÅÔ∏è Ver detalhes</div>
          <div class="path-menu-item" onclick="restartTrilha(${path.id})">üîÑ Refazer trilha</div>
          <div class="path-menu-item danger" onclick="deleteTrilha(${path.id})">üóëÔ∏è Remover da lista</div>
        `;
      }
      return div;
    }

    // Toggle menu
    function toggleMenu(event, id) {
      event.stopPropagation();
      document.querySelectorAll('.path-menu').forEach(m=>m.id!==`menu-${id}`?m.classList.remove('show'):null);
      document.getElementById(`menu-${id}`)?.classList.toggle('show');
    }
    document.addEventListener('click', ()=>document.querySelectorAll('.path-menu').forEach(m=>m.classList.remove('show')));

    // Carrega e renderiza
    document.addEventListener('DOMContentLoaded', async ()=>await carregarEExibir());

    async function carregarEExibir() {
      try {
        const url = "{% url 'trilhas:minhas_trilhas' %}?format=json";
        const res = await fetch(url,{credentials:'same-origin'});
        if(!res.ok)throw new Error('Falha ao buscar trilhas');
        const data = await res.json();
        populateGrid('inProgressGrid', data.inProgress, 'in-progress');
        populateGrid('pausedGrid', data.paused, 'paused');
        populateGrid('completedGrid', data.completed, 'completed');
      } catch(err){
        console.error(err);
        document.getElementById('inProgressGrid').innerHTML='<div class="empty-state"><div class="empty-state-title">Erro ao carregar trilhas</div></div>';
        document.getElementById('pausedGrid').innerHTML='';
        document.getElementById('completedGrid').innerHTML='';
      }
    }

    function populateGrid(gridId, items, status){
      const grid = document.getElementById(gridId);
      const countEl = document.getElementById(gridId.replace('Grid','Count'));
      grid.innerHTML='';
      countEl.textContent=items.length||0;
      if(!items||items.length===0){
        grid.innerHTML=`<div class="empty-state">
          <div class="empty-state-icon">üìö</div>
          <div class="empty-state-title">Nenhuma trilha ${status==='in-progress'?'em progresso':status==='paused'?'pausada':'conclu√≠da'}</div>
          <div class="empty-state-description">${status==='in-progress'?'Comece':status==='paused'?'Pause':'Conclua'} uma trilha para aparecer aqui </div>
        </div>`;
        return;
      }
      items.forEach(p=>{
        const path={
          id:p.id,
          title:p.title||p.titulo||'Sem t√≠tulo',
          description:p.description||p.descricao||'',
          duration:p.duration||'‚Äî',
          level:p.level||'‚Äî',
          progress:typeof p.progress==='number'?p.progress:(p.progress||0)
        };
        grid.appendChild(createPathCard(path,status));
      });
    }

    // Fun√ß√µes de a√ß√£o
    async function sendAction(action,trilhaId){
      const url="{% url 'trilhas:minhas_trilhas' %}";
      const body=`action=${encodeURIComponent(action)}&trilha_id=${encodeURIComponent(trilhaId)}`;
      const res = await fetch(url,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body});
      if(res.ok){try{const json=await res.json();}catch(e){}await carregarEExibir();}
      else {const text=await res.text();console.error('Erro a√ß√£o:',res.status,text);alert('Erro ao executar a√ß√£o');}
    }

    function pauseTrilha(id){sendAction('pause',id);}
    function resumeTrilha(id){sendAction('resume',id);}
    function restartTrilha(id){sendAction('restart',id);}
    function deleteTrilha(id){
      if(confirm('Tem certeza que deseja excluir esta trilha?')) sendAction('delete',id);
    }
    function verDetalhes(id){window.location.href='{% url "trilhas:ver_etapas" %}?id='+encodeURIComponent(id);}
  </script>
</body>
</html>