<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guia de Estudos - EstudaAI</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/global.css' %}">
  <link rel="stylesheet" href="{% static 'css/descricaoTrilha.css' %}">
</head>
<body>
  <nav class="navbar">
    <div class="container navbar-content">
      <a href="{% url 'trilhas:dashboard' %}" class="navbar-brand">
        <div class="logo">üéì</div>
        <span>EstudaAI</span>
      </a>
      <ul class="navbar-menu">
        <li><a href="{% url 'trilhas:dashboard' %}">Dashboard</a></li>
        <li><a href="{% url 'trilhas:minhas_trilhas' %}">Minhas Trilhas</a></li>
        <li><a href="{% url 'trilhas:todas_trilhas' %}" class="active">Explorar</a></li>
        <li><a href="{% url 'trilha_personalizada' %}">Criar Trilha</a></li>
      </ul>
      <div class="navbar-actions">
        <div class="user-profile" onclick="toggleUserMenu()">
          <div class="user-avatar">{{ request.user.nickname|first|upper }}</div>
          <span id="userName">{{ request.user.nickname }}</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="container-wide">
      <div class="path-hero">
          <span class="path-category">{{ trilha.categoria.nome }}</span>
          <h1 class="path-title">{{ trilha.titulo }}</h1>
          <p class="path-description">{{ trilha.descricao }}</p>
          <div class="path-stats">
              <span class="path-stat">üìä {{ trilha.get_dificuldade_display }}</span>
              <span class="path-stat">üìö {{ trilha.etapas.count }} etapas</span>
              <span class="path-stat">üéØ {{ trilha.projetos.count }} projeto(s) final(is)</span>
          </div>
      </div>

      <div class="content-grid">
          <div class="guide-section" id="guideSection">
              {% for etapa in etapas_data %}
              <div class="study-card">
                  <div class="study-header">
                      <div style="flex:1;">
                          <div class="study-number">{{ etapa.number }}</div>
                          <div class="study-title">{{ etapa.title }}</div>
                      </div>
                  </div>
                  <div class="study-description">{{ etapa.description }}</div>
                  <div class="study-topics">
                      {% for topico in etapa.topics %}
                      <div class="topic-item" data-id="{{ topico.id }}">
                          <div class="topic-checkbox {% if topico.completed %}checked{% endif %}" id="topic-{{ topico.id }}">
                              {% if topico.completed %}‚úì{% endif %}
                          </div>
                          <div class="topic-text">{{ topico.text }}</div>
                      </div>
                      {% endfor %}
                  </div>
              </div>
              {% endfor %}

              {% if projeto %}
              <div class="project-card">
                  <span class="project-badge">üéØ PROJETO FINAL</span>
                  <h2 class="project-title">{{ projeto.titulo }}</h2>
                  <p class="project-description">{{ projeto.descricao }}</p>
              </div>
              {% endif %}
          </div>

          <aside class="sidebar">
              <div class="progress-card">
                  <h3 class="progress-title">Seu Progresso</h3>
                  <div class="progress-circle">
                      <svg width="120" height="120">
                          <defs>
                              <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                  <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                                  <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                              </linearGradient>
                          </defs>
                          <circle class="progress-circle-bg" cx="60" cy="60" r="52"></circle>
                          <circle class="progress-circle-fill" cx="60" cy="60" r="52"
                                  stroke-dasharray="326.73"
                                  stroke-dashoffset="{{ stroke_offset }}"
                                  id="progressCircle"></circle>
                      </svg>
                      <div class="progress-text" id="progressText">{{ progresso_percentual }}%</div>
                  </div>
                  <div class="progress-stats">
                      <div class="progress-stat">
                          <span class="progress-stat-label">Conclu√≠do</span>
                          <span class="progress-stat-value" id="completedTopics">{{ topicos_concluidos }}/{{ total_topicos }} t√≥picos</span>
                      </div>
                  </div>
              </div>
              <button class="btn btn-primary" style="width: 100%;">‚ñ∂Ô∏è Continuar Estudando</button>
          </aside>
      </div>
    </div>
  </main>

<script>
  const totalTopicos = {{ total_topicos }};
  const progressCircle = document.getElementById('progressCircle');
  const progressText = document.getElementById('progressText');
  const completedTopicsEl = document.getElementById('completedTopics');

  // Adiciona eventos aos t√≥picos existentes
  document.querySelectorAll('.topic-item').forEach(item => {
    item.addEventListener('click', () => {
      const topicId = item.getAttribute('data-id');
      toggleTopic(topicId);
    });
  });

  function toggleTopic(topicId) {
    const checkbox = document.getElementById(`topic-${topicId}`);
    const isChecked = checkbox.classList.contains('checked');
    const newStatus = !isChecked;

    // Atualiza visualmente
    if (newStatus) {
      checkbox.classList.add('checked');
      checkbox.textContent = '‚úì';
    } else {
      checkbox.classList.remove('checked');
      checkbox.textContent = '';
    }

    // Atualiza progresso
    updateProgress();

    // Envia para o backend
    fetch("{% url 'trilhas:toggle_topico' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: `topico_id=${topicId}&completed=${newStatus}`
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        console.error("Erro ao atualizar t√≥pico:", data.error);
      }
    })
    .catch(err => console.error("Erro na requisi√ß√£o:", err));
  }

  function updateProgress() {
    const completedTopics = document.querySelectorAll('.topic-checkbox.checked').length;
    const percentage = Math.round((completedTopics / totalTopicos) * 100);

    progressText.textContent = percentage + '%';
    completedTopicsEl.textContent = `${completedTopics}/${totalTopicos} t√≥picos`;

    const circumference = 326.73;
    const offset = circumference - (percentage / 100) * circumference;
    progressCircle.style.strokeDashoffset = offset;
  }

  // Inicializa o progresso
  updateProgress();
</script>
</body>
</html>
